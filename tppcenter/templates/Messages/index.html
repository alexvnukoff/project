{% extends 'main_page.html' %}
{% load static from staticfiles %}
{% load i18n %}


   {% block title %}News{% endblock %}

    {% block styles %}
         {{ block.super }}
         <link type="text/css" rel="stylesheet" href="{% static "tppcenter/css/news.css" %}" />
         <link type="text/css" rel="stylesheet" href="{% static "tppcenter/css/company.css" %}" />
    {% endblock %}


    {% block js %}
         {{ block.super }}
        <script type="text/javascript" src="{% static "tppcenter/js/ajax.queue.min.js" %}"></script>


 <script type="text/javascript">


    var messagesUI = {

        curChat: 'mess-cur' ,
        chatList: '.message-tabcontent',
        messageLine: '.customline',
        messageBox: '.custom-contentin',
        messageList: '.message-list',
        textarea: '#message-box-',
        chatWindow: 'custom-content-',


        onScrollTop: function( el ) {

            el.unbind( 'scroll' );

            if ( el.find( '.last' ).length )
                return true;

            var active_id = $( '.' + messagesUI.curChat + ' a' ).data( 'user-id' );

            el.find( '.dateline:first' ).replaceWith( '<div class="message-paging-loader">' +
                                                        '<img class="im-test" src="/static/tppcenter/img/messages-loader.gif" />' +
                                                    '</div>' );

            var last_message = el.find( messageLine + ':first' );
            var date = last_message.data( 'date' );
            var lid =  last_message.data( 'message' );
            var url = '/messages/' + active_id + '/';

            $.ajaxQueue({

                url: url,
                data: {
                    page: 2,
                    lid: lid,
                    date: date
                },

                success: function(data) {

                    messagesUI.bindSccroll();

                    el.find( '.message-paging-loader' ).replaceWith( data );
                },

                type: 'GET'
            });
        },

        bindSccroll: function() {

            $( messagesUI.messageBox ).unbind( 'scroll' );

            $( messagesUI.messageBox + ':visible' ).bind( 'scroll', function() {

                 if( $(this).scrollTop() == 0 )
                    messagesUI.onScrollTop( $(this) );
            });
        },

        scroollMessageDown: function() {

            var content = $( messagesUI.messageBox + ':visible' );
            var height = content.find( messagesUI.messageList ).height();

            content.scrollTop( height );

        },

        sendMessage: function() {

            var active_id = $( '.' + messagesUI.curChat + ' a' ).data( 'user-id' );

            if ( !active_id )
                return false;

            var textarea = $( messagesUI.textarea + active_id );
            var val = textarea.val();

            if ( val == '' )
                return false;

            textarea.attr( 'disabled', 'disabled' );

            $.ajaxQueue({

                url: '/messages/add/',
                data: {
                    text: val,
                    active: active_id
                },

                success: function( data ) {

                    messagesUI.getMessages( active_id );
                    textarea.val( '' );
                    textarea.removeAttr( 'disabled' );

                },

                type: 'POST'
            });

           return false;

        },

        getMessages: function( coll ) {
            var selector = $( '#' + messagesUI.chatWindow + coll );

            if ( selector.length == 0 )
                return false;

            var lastTime = selector.find( messagesUI.messageLine + ':last' ).data( 'date' );
            var lid = selector.find( messagesUI.messageLine + ':last' ).data( 'message' );
            var url = '/messages/' + coll + '/';

            jQuery.ajaxQueue({

                url: url,
                data: {
                    date: lastTime,
                    lid: lid
                },

                success: function( data ) {

                    selector.find( messagesUI.messageList ).append( data );
                    messagesUI.scroollMessageDown();
                },

                dataType: 'html',
                type: 'GET'
            });
        },

        getMessageBox: function( coll, newPanel ) {

            var url = '/messages/' + coll + '/';
            var content = ''

            History.pushState( null, null, url );

            jQuery.ajaxQueue({

                url: url,
                data: {box: 1},

                success: function( data ) {

                    newPanel.html( data );
                    messagesUI.scroollMessageDown();
                    messagesUI.bindSccroll()

                },

                dataType: 'html',
                type: 'GET'
            });
        },

        init: function() {
            $( ".messages-l" ).tabs({
                beforeActivate: function( event, ui ) {

                    var subTab = ui.newPanel.find( messagesUI.chatList );
                    var curr = subTab.tabs( 'option','active' );

                    if ( curr != 0 )
                    {
                        subTab.tabs( 'option','active', 0 );
                        subTab.tabs( 'option','active', curr );
                    }

                }
            });


            $( messagesUI.chatList ).tabs({

                beforeLoad: function( event, ui ) {
                    ui.panel.html('<div class="message-loader"><img src="/static/tppcenter/img/messages-loader.gif" /></div>');
                },

                load: function( event, ui ) {

                    var tabLink = ui.tab.find( 'a' );
                    var id = tabLink.data( 'user-id' );
                    var tab = $( '<div></div>' ).attr( 'id', messagesUI.chatWindow + id ).append( ui.panel );

                    tabLink.attr( 'href', '#' + messagesUI.chatWindow + id );

                    $(this).append( tab );

                    messagesUI.scroollMessageDown();
                    messagesUI.bindSccroll();
                },

                activate: function( event, ui) {

                    var url = ui.newTab.find( 'a' ).attr( 'href' );

                    History.pushState( null, null, url.replace( '?box=1', '' ) );

                    $( messagesUI.chatList + " ." + messagesUI.curChat ).removeClass( messagesUI.curChat )
                    ui.newTab.addClass( messagesUI.curChat );
                }
            });



            $(document).on( 'click', 'a.send-message', messagesUI.sendMessage );

            $(document).bind( 'new_message', function( ev, fromUser ) {

                var active_id = $( '.' + messagesUI.curChat  + ' a').data('user-id');

                if ( fromUser == active_id )
                    messagesUI.getMessages( active_id );
            });

            messagesUI.scroollMessageDown();
            messagesUI.bindSccroll();

        }

    }





    $(function() {
        messagesUI.init();

    });
</script>

    {% endblock %}

     {% block content %}
<div class="analytics">
				<div class="community">
                	<div class="messages-l">
                    	<div class="tab-cate">
                            <ul>
                                <li {% if active in organizations %} class="ui-tabs-active" {% endif %}>
                                    <a href="#message-tabs-1">{% trans "Organizations" %}</a>
                                </li>
                                <li {% if active in cabinets %} class="ui-tabs-active" {% endif %} >
                                    <a href="#message-tabs-2">{% trans "Users" %}</a>
                                </li>
                            </ul>
                        </div>
                        <div id="message-tabs-1">
                            <div class="message-tabcontent message-tabcontent-org">
								<ul class="custom-ms">
                                    {% for id, attr in organizations.items %}
                                        {% with attr.NAME|first as name %}
                                        {% with attr.IMAGE|first as image %}
                                        <li style="display: none"><a href="#placeholder"></a> </li>
                                        <li {% if active == id %}class="mess-cur ui-tabs-active"{% endif %}>
                                            <span class="thumb"></span>
                                            <a data-user-id="{{ id }}" href="#custom-content-{{ id }}">
                                                {{ name|truncatewords:3 }}
                                            </a>
                                        </li>
                                        {% endwith %}
                                        {% endwith %}
                                    {% endfor %}

                                </ul>
                                {% if active in organizations %}
                                    <div id="custom-content-{{ active }}">
                                        {% include "Messages/contentBox.html" %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        <div id="message-tabs-2">
                            <div class="message-tabcontent message-tabcontent-cab">
								<ul class="custom-ms">
                                    {% for id, attr in cabinets.items %}
                                        {% with attr.USER_LAST_NAME|first as last_name %}
                                        {% with attr.USER_FIRST_NAME|first as first_name %}
                                        {% with attr.USER_MIDDLE_NAME|first as middle_name %}
                                        {% with attr.IMAGE|first as image %}
                                        <li style="display: none"><a href="#placeholder"></a> </li>
                                        {% if active == id %}
                                        <li class="mess-cur ui-tabs-active">
                                                <span class="thumb"></span>
                                                <a data-user-id="{{ id }}" href="#custom-content-{{ id }}">
                                                    {{ first_name }} {{ last_name }}
                                                </a>
                                        </li>
                                        {% else %}
                                        <li>
                                            <span class="thumb"></span>
                                            <a data-user-id="{{ id }}" href="{% url "messages:message_item" id  %}?box=1">
                                                {{ first_name }} {{ last_name }}
                                            </a>
                                        </li>
                                        {% endif %}
                                        {% endwith %}
                                        {% endwith %}
                                        {% endwith %}
                                        {% endwith %}
                                    {% endfor %}

                                </ul>
                                                            {% if active in cabinets %}
                                    <div id="custom-content-{{ active }}">

                                    {% include "Messages/contentBox.html" %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
     {% endblock %}

