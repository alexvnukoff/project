{% extends 'main_page.html' %}
{% load static from staticfiles %}
{% load i18n %}

{% block styles %}
    {{ block.super }}
    <link type="text/css" rel="stylesheet" href="{% static 'tppcenter/css/company.css' %}" />
    <link type="text/css" rel="stylesheet" href="{% static 'tppcenter/css/datepicker.css' %}">
    <style>
        .select2-container-multi .select2-choices {
         max-height: 150px !important;
         overflow: auto;
         margin: 5px ;
        }
        .ads-details-center .filter {
            margin-top: 5px;
        }
        .ads-details-center .filter label {
            font-weight: bold;

        }
        .ads-details-center .ads-line:after {
           content: "";
           display: block;
           clear: both;
        }
    </style>

{% endblock %}


{% block js %}
    {{ block.super }}
    <script type="text/javascript" src="{% static 'tppcenter/js/jquery.slimscroll.min.js' %}"></script>

    <script type="text/javascript">
        $(function() {
            $( "#tabs" ).tabs();
            $( ".tabfilter" ).tabs();


            $(".messages-l").tabs();
            $(".message-tabcontent").tabs();
            $('.custom-ms').slimScroll({
                height: '750px',
                railVisible: true,
                alwaysVisible: false
            });
            $('.customtablein').slimScroll({
                height: '580px',
                railVisible: true,
                alwaysVisible: true
            });
            $('.ads-pricein').slimScroll({
                height: '270px',
                railVisible: true,
                alwaysVisible: true
            });
            //slimScroll fix
            $('.arrow-scroll-down').click(function(){
                $(this).parent().find('.custom-ms').trigger('scrollContent', [1] );
                $(this).parent().find('.customtablein').trigger('scrollContent', [1] );
                $(this).parent().find('.clumnin').trigger('scrollContent', [1] );
                $(this).parent().find('.ads-pricein').trigger('scrollContent', [1] );
            });

            $('.arrow-scroll-up').click(function(){
                $('.custom-ms').trigger('scrollContent', [-1] );
                $('.customtablein').trigger('scrollContent', [-1] );
                $('.clumnin').trigger('scrollContent', [-1] );
                $('.ads-pricein').trigger('scrollContent', [-1] );
            });


            $('.ads-details-center .filter input').select2({
                    width: "100%",
                    multiple:true,
                    formatNoMatches: noMatches,
                    ajax: {
                        url: "/advbanner/filter/",
                        dataType: 'json',
                        quietMillis: 100,
                        data: function (term, page) { // page is the one-based page number tracked by Select2
                        return {
                            page: page, // page number
                            type: $(this).attr('name')
                            };
                        },
                        results: function (data, page) {
                            var more = (page * 10) < data.total; // whether or not there are more results available
                            // notice we return the value of more so Select2 knows if more results can be loaded
                            return {results: data.content, more: more};
                        }

                    },
                    formatResult: function (m) { return m.title; }, // omitted for brevity, see the source of this page
                    formatSelection: function (m) { return m.title; }, // omitted for brevity, see the source of this page
                    escapeMarkup: function (m) { return m; } // we do not want to escape markup since we are displaying html in results
            });

            var advForm = $('form[name="advForm"]');
            var priceList = $('.ads-pricein ul');
            var totalCost = 0;
            var total = $('.total-price.white .right b:first');
            var totalDays = $('.total-price.brown .right');
            var days = 0;
            var stDate;
            var edDate;

            var initial = {
                branch: []
                country: [],
                tpp: []
            }





            {% if edDate %}
                edDate = '{{ edDate }}';
            {% endif %}

            {% if stDate %}
                stDate = '{{ stDate }}';
            {% endif %}

            $( "#date-start" ).datepicker({
              changeMonth: true,
              minDate: 0,
              onClose: function( selectedDate ) {
                $( "#date-end" ).datepicker( "option", "minDate", selectedDate );

                stDate = new Date(selectedDate.replace(/(\d{2})\/(\d{2})\/(\d{4})/,'$3-$1-$2'));
                setDays();
              }
            });



            $( "#date-end" ).datepicker({
              defaultDate: "+1d",
              changeMonth: true,
              minDate: '+1d',
              onClose: function( selectedDate ) {
                $( "#date-start" ).datepicker( "option", "maxDate", selectedDate );
                edDate = new Date(selectedDate.replace(/(\d{2})\/(\d{2})\/(\d{4})/,'$3-$1-$2'));
                setDays();
              }
            });

            if ( edDate )
                $( "#date-start").datepicker( "option", "maxDate", edDate );

            if ( stDate )
                $( "#date-end").datepicker( "option", "minDate", stDate );


            function setDays() {

                if (stDate && edDate)
                {
                    var mSec = Math.abs(edDate - stDate);

                    if ( !mSec || mSec <= 0 )
                        days = 0;
                    else
                        days = Math.round((mSec / (1000 * 60 * 60 * 24)));

                    totalDays.html(days)
                    setTotal();
                }
            }

            function setTotal() {
                var newCost = totalCost * days;

                newCost = newCost.toFixed(2).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
                total.text(newCost);

            }

            $('.ads-details-center .filter input').on("change", function(e) {
                if ( e.added ) {

                     var input = $('<input />');
                     var name = $(this).attr('name')

                    input.attr({
                        name: "filter[" + name + "][]",
                        value: e.added.id,
                        type: 'hidden'
                    });

                    input.data('cost', e.added.cost);

                    e.added.cost = parseFloat(e.added.cost);
                    cost = e.added.cost.toFixed(2).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");

                    html = $('<li></li>').addClass('basket-' + e.added.id);
                    html.append('<span class="left">' + e.added.title + '</span>');
                    html.append('<span class="right">' + cost + ' $/сут</span>');

                    priceList.append(html);
                    totalCost += e.added.cost;

                    setTotal();

                    input.appendTo(advForm);
                } else if ( e.removed ) {
                    toRemove = advForm.find('input[value="' + e.removed.id + '"]');

                    cost = toRemove.data('cost');
                    toRemove.remove();
                    priceList.find('li.basket-' + e.removed.id).remove();

                    totalCost -= parseFloat(cost);
                    setTotal();
                }

            });
        });
    </script>
{% endblock %}



{% block center %}
<div class="ads-details">
    <form enctype="multipart/form-data" method="post" action="" name="advForm">
        {% with form.fields.NAME.initial as name %}
        {% with form.fields.SITE_NAME.initial as url %}

        {% csrf_token %}

        <div class="ads-details-center">
            {% if form.errors.DATE %}
                <div class="formserror">{{ form.errors.DATE }}</div>
            {% endif %}

            {% if form.errors.ERROR %}
                <div class="formserror">{{ form.errors.ERROR }}</div>
            {% endif %}

            <ul class="ads-line">
                <li>
                    <label>{% trans "Image file (Maximum 50KB)" %}</label>
                    {% if form.errors.IMAGE %}
                        <div class="formserror">{{ form.errors.IMAGE }}</div>
                    {% endif %}
                    <div class="img-ads">
                        <input type="file" name="IMAGE" />
                        <div class="gray-img"></div>
                    </div>
                </li>
                <li>
                    <div class="clumn1">
                        <label>{% trans "Link URL" %}</label>
                        {% if form.errors.URL %}
                            <div class="formserror">{{ form.errors.URL }}</div>
                        {% endif %}
                        <input type="text" name="SITE_NAME" value="{{ url }}" placeholder="" class="text" />
                    </div>
                    <div class="clumn2">
                        <label>{% trans "Start date" %}</label>
                        <input value="{{ stDate }}" type="text" name="st_date" placeholder="" id="date-start" />
                    </div>
                </li>
                <li>
                    <div class="clumn1">
                        {% if form.errors.NAME %}
                            <div class="formserror">{{ form.errors.NAME }}</div>
                        {% endif %}

                        <label>{% trans "Image title" %}</label>
                        <textarea name="NAME" rows="3">{{ name }}</textarea>
                    </div>
                    <div class="clumn2">
                        <label>{% trans "End date" %}</label>
                        <input type="text" value="{{ edDate }}" name="ed_date" placeholder="" id="date-end" />
                    </div>
                </li>
            </ul>

            <div class="filter">
                {% if form.errors.FILTER %}
                    <div class="formserror">{{ form.errors.FILTER }}</div>
                {% endif %}
                <label>{% trans "Filter" %}</label>
                {% for name, placeholder in enable.items %}
                    <input name="{{ name }}" placeholder="{{ placeholder }}" type="hidden" />
                {% endfor %}
            </div>
        </div>
        <div class="ads-details-right">

            <div class="title">{% trans "Basket" %}</div>
                <div class="ads-price">
                	<div class="arrow-scroll-up"></div>
                	<div class="ads-pricein">
                    	<ul>
                        </ul>
                    </div>
                    <div class="arrow-scroll-down"></div>
                </div>
                <div class="total-price brown">
                	<span class="left">{% trans "Days Q-ty" %}:</span>
                    <span class="right">0</span>
                </div>
                <div class="total-price white">
                	<span class="left"><b>{% trans "Summary" %}:</b></span>
                    <span class="right"><b>0.00</b><b> $</b></span>
                </div>


                <input type="submit" class="btnprice" value="{% trans "Pay" %}">
            </div>
        {% endwith %}
        {% endwith %}
    </form>
</div>
{% endblock %}

{% block right %}
{% endblock %}