{% load i18n %}

<form id="new_message_form" action="{% url 'messages:add_to_chat' %}" method="POST" enctype="multipart/form-data">
<div class="panel panel-default panel-adviser">
    <div class="panel-heading">
    {% csrf_token %}
    {{ new_message_form.recipient }}
    </div>
    <div class="panel-body" 
        style="max-height: 300px; min-height:300px; overflow-y: scroll;"></div>
    <div class="panel-footer">
        <div style="width: 70%; float:left;">
            {{ new_message_form.content }}
        </div>
        <div style="width: 25%; float: right;"><button>OK1</button>&nbsp;<button>OK2</button></div>
        <div style="clear:both;"></div>
    </div>
</div>
</form>

<script type="text/javascript">
    {% with new_message_form.get_staff_avatars as avatars %}
    var userAvatars = {
        {% for user_id, user_avatar in avatars.items %}'{{ user_id }}' : '{{ user_avatar }}',{% endfor %}
    };
    {% endwith %}

    function formatOption(opt) {
        if (opt.id) { 
            var opt_id = opt.id.toString();
            if (opt_id in userAvatars) {
                return '<img src="' + userAvatars[opt_id] + '">&nbsp;' + opt.text;
            } else {
                return '<img src="static/b24online/img/profile_24x24.jpg">&nbsp;' + opt.text;
            }
        }
        return opt.text;
    }

    var recipientId = '#id_recipient';
    //$(recipientId).select2({
    //    formatResult: formatOption,
    //    formatSelection: formatOption,
    //});

    $(document).on('click', '#adviser_save_message', function(e) {
        e.preventDefault(); 
        var processed_form = $(this).parents('form:first');
        $(processed_form).find('.field-error').empty().addClass('error-hidden');
        $(processed_form).find('.form-group .has-error').removeClass('has-error');
        $(processed_form).ajaxSubmit({
            url: this.href,
            type: 'post',
            success: function(data) {
                $(this).prop('disabled', true);
                if (data.code == 'error') {

                } else if (data.code == 'success') {
                    $(processed_form).clearForm();
                }
                $(this).prop('disabled', false);
            }
        });
        return false;
	});
    
</script>
