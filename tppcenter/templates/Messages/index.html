{% extends 'main_page.html' %}
{% load static from staticfiles %}
{% load i18n %}


   {% block title %}News{% endblock %}

    {% block styles %}
         {{ block.super }}
         <link type="text/css" rel="stylesheet" href="{% static "tppcenter/css/news.css" %}" />
         <link type="text/css" rel="stylesheet" href="{% static "tppcenter/css/company.css" %}" />
    {% endblock %}


    {% block js %}
         {{ block.super }}
        <script type="text/javascript" src="{% static "tppcenter/js/ajax.queue.min.js" %}"></script>
        <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/waypoints/2.0.3/waypoints.js"></script>


 <script type="text/javascript">

     function onScrollTop(el) {

            el.unbind('scroll');

            if (el.find('.last').length)
                return true;

            var page = $(this).data('page');
            var active_id = $('.mess-cur a').data('user-id');
            el.find('.dateline:first').replaceWith('<div class="message-paging-loader">' +
                                                        '<img class="im-test" src="/static/tppcenter/img/messages-loader.gif" />' +
                                                    '</div>');
            var last_message = el.find('.customline:first');
            var date = last_message.data('date');
            var lid =  last_message.data('message');

            var url = '/messages/' + active_id + '/';

            $.ajaxQueue({
                url: url,
                data: {
                    page: 2,
                    lid: lid,
                    date: date
                },
                success: function(data) {
                    bindSccroll();

                    el.find('.message-paging-loader').replaceWith(data);
                },
                type: 'GET'
            });

     }

     function bindSccroll()
     {
        $('.custom-contentin').unbind('scroll');

        $('.custom-contentin:visible').bind('scroll', function() {

         if($(this).scrollTop() == 0)
         {
            onScrollTop($(this))
         }
        });
     }



    $(function() {





        $( "#tabs" ).tabs();
        $( ".date" ).datepicker();
        $(".messages-l").tabs();

        function scroollMessageDown() {
            var content = $('.custom-contentin:visible');
            content.scrollTop(content.find('.message-list').height());
        }


        function sendMessage()
        {
            var active_id = $('.mess-cur a').data('user-id');

            if (!active_id)
                return false;

            var textarea = $('#message-box-'+ active_id);
            var val = textarea.val();

            if (val == '')
                return false;

            textarea.attr('disabled', 'disabled');

            $.ajaxQueue({
                url: '/messages/add/',
                data: {
                    text: val,
                    active: active_id
                },
                success: function(data) {
                    getMessages(active_id);
                    textarea.val('');
                    textarea.removeAttr('disabled')
                },
                type: 'POST'
            });

           return false;
        }

        function getMessages(coll) {
            var selector = $('#custom-content-' + coll);

            if (selector.length == 0)
                return false;

            var lastTime = selector.find('.customline:last').data('date');
            var lid = selector.find('.customline:last').data('message');
            var url = '/messages/' + coll + '/';

            jQuery.ajaxQueue({
                url: url,
                data: {
                    date: lastTime,
                    lid: lid
                },
                type: 'GET',
                success: function(data) {
                    selector.find('.message-list').append(data);
                    scroollMessageDown();
                },
                dataType: 'html'
            });

        }

        function getMessageBox(coll, newPanel) {
            var url = '/messages/' + coll + '/';
            var content = ''
            History.pushState(null, null, url);

            jQuery.ajaxQueue({
                url: url,
                type: 'GET',
                data: {box: 1},
                success: function(data) {
                     newPanel.html(data);
                    scroollMessageDown();
                    bindSccroll()
                },
                dataType: 'html'
            });
        }

        $(".message-tabcontent").tabs({
            beforeLoad: function( event, ui ) {
                ui.panel.html('<div class="message-loader"><img src="/static/tppcenter/img/messages-loader.gif" /></div>');
            },

            load: function( event, ui ) {
                var tabLink = ui.tab.find('a');
                var id = tabLink.data('user-id');
                var tab = $('<div></div>').attr('id', 'custom-content-' + id).append(ui.panel);

                tabLink.attr('href', 'custom-content-' + id);
                $(this).append(tab);
                scroollMessageDown();
                bindSccroll();
            },

            activate: function( event, ui) {
                var url = ui.newTab.find('a').attr('href');

                History.pushState(null, null, url.replace('?box=1', ''));

                $(".message-tabcontent .mess-cur").removeClass('mess-cur')
                ui.newTab.addClass('mess-cur');
            }
        });



        $(document).on('click', 'a.send-message', sendMessage);
        $(document).bind('new_message', function(ev, fromUser) {
            var active_id = $('.mess-cur a').data('user-id');

            if (fromUser == active_id)
                getMessages(active_id);
        });

        scroollMessageDown();
               bindSccroll()
    });
</script>

    {% endblock %}

     {% block content %}
<div class="analytics">
				<div class="community">
                	<div class="messages-l">
                    	<div class="tab-cate">
                            <ul>
                                <li {% if active in organizations %} class="ui-tabs-active" {% endif %}>
                                    <a href="#message-tabs-1">{% trans "Organizations" %}</a>
                                </li>
                                <li {% if active in cabinets %} class="ui-tabs-active" {% endif %} >
                                    <a href="#message-tabs-2">{% trans "Users" %}</a>
                                </li>
                            </ul>
                        </div>
                        <div id="message-tabs-1">
                            <div class="message-tabcontent message-tabcontent-org">
								<ul class="custom-ms">
                                    {% for id, attr in organizations.items %}
                                        {% with attr.NAME|first as name %}
                                        {% with attr.IMAGE|first as image %}
                                        <li style="display: none"><a href="#placeholder"></a> </li>
                                        <li {% if active == id %}class="mess-cur ui-tabs-active"{% endif %}>
                                            <span class="thumb"></span>
                                            <a data-user-id="{{ id }}" href="#custom-content-{{ id }}">
                                                {{ name|truncatewords:3 }}
                                            </a>
                                        </li>
                                        {% endwith %}
                                        {% endwith %}
                                    {% endfor %}

                                </ul>
                                {% if active in organizations %}
                                    <div id="custom-content-{{ active }}">
                                        {% include "Messages/contentBox.html" %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        <div id="message-tabs-2">
                            <div class="message-tabcontent message-tabcontent-cab">
								<ul class="custom-ms">
                                    {% for id, attr in cabinets.items %}
                                        {% with attr.USER_LAST_NAME|first as last_name %}
                                        {% with attr.USER_FIRST_NAME|first as first_name %}
                                        {% with attr.USER_MIDDLE_NAME|first as middle_name %}
                                        {% with attr.IMAGE|first as image %}
                                        <li style="display: none"><a href="#placeholder"></a> </li>
                                        {% if active == id %}
                                        <li class="mess-cur ui-tabs-active">
                                                <span class="thumb"></span>
                                                <a data-user-id="{{ id }}" href="#custom-content-{{ id }}">
                                                    {{ first_name }} {{ last_name }}
                                                </a>
                                        </li>
                                        {% else %}
                                        <li>
                                            <span class="thumb"></span>
                                            <a data-user-id="{{ id }}" href="{% url "messages:message_item" id  %}?box=1">
                                                {{ first_name }} {{ last_name }}
                                            </a>
                                        </li>
                                        {% endif %}
                                        {% endwith %}
                                        {% endwith %}
                                        {% endwith %}
                                        {% endwith %}
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
     {% endblock %}

